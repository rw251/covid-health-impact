--Just want the output, not the messages
SET NOCOUNT ON; 

--populate table with all dates from 2015-01-01
IF OBJECT_ID('tempdb..#AllDates') IS NOT NULL DROP TABLE #AllDates;
CREATE TABLE #AllDates ([date] date);
declare @dt datetime = '2015-01-01'
declare @dtEnd datetime = '2020-05-14';
WHILE (@dt <= @dtEnd) BEGIN
    insert into #AllDates([date])
        values(@dt)
    SET @dt = DATEADD(day, 1, @dt)
END;

-- Populate incidence table - only count those occurrences
-- of the code where it is the first time the patient has had it
select FirstDiagnosis, count(*) as num into #Incidence from (
	select PatID, min(EntryDate) as FirstDiagnosis from SIR_ALL_Records_Narrow
	where ReadCode in ('d2b..00','d2bz.00','d2by.00','d2b2.00','d2b1.00','d2a..00','d2az.00','d2a2.00','d2a1.00','d2ax.00','d2a7.00','d2a6.00','d2a5.00','d2a4.00','d2a3.00','d2d..00','d2d4.00','d2d3.00','d2d2.00','d2d1.00','d2d7.00','d2d6.00','d2d5.00','d2e..00','d2ez.00','d2e1.00','d29..00','d29z.00','d29y.00','d292.00','d291.00','d24..00','d248.00','d247.00','d246.00','d24j.00','d24i.00','d24h.00','d24g.00','d24f.00','d24e.00','d24d.00','d24c.00','d24b.00','d24a.00','d249.00','d245.00','d244.00','d243.00','d242.00','d242.11','d241.00','d241.11','d26..00','d268.00','d266.00','d263.00','d261.00','d26A.00','d269.00','d267.00','d265.00','d264.00','d262.00','d27..00','d27z.00','d27y.00','d272.00','d271.00','d21..00','d21z.00','d21J.00','d21A.00','d216.00','d215.00','d214.00','d213.00','d212.00','d211.00','d21y.00','d21x.00','d21w.00','d21v.00','d21u.00','d21t.00','d21s.00','d21r.00','d21q.00','d21p.00','d21o.00','d21n.00','d21m.00','d21l.00','d21k.00','d21j.00','d21i.00','d21h.00','d21g.00','d21f.00','d21e.00','d21d.00','d21c.00','d21b.00','d21a.00','d21G.00','d21F.00','d21E.00','d21D.00','d21C.00','d21B.00','d219.00','d218.00','d217.00','d23..00','d23z.00','d23y.00','d232.00','d231.00','d22..00','d22z.00','d22y.00','d222.00','d221.00','d14..00','d14z.00','d141.00','d15..00','d15z.00','d15y.00','d154.00','d153.00','d152.00','d151.00','d17..00','d172.00','d171.00','d174.00','d173.00','d16..00','d161.00','d162.00','d18..00','d18f.00','d184.00','d183.00','d182.00','d181.00','d18e.00','d18d.00','d18c.00','d18b.00','d18a.00','d189.00','d188.00','d187.00','d186.00','d185.00','d1a..00','d1ao.00','d1ak.00','d1aj.00','d1ai.00','d1ah.00','d1ag.00','d1af.00','d1ae.00','d1ad.00','d1ac.00','d1ab.00','d1aa.00','d1a9.00','d1a8.00','d1a5.00','d1a4.00','d1a3.00','d1a2.00','d1a1.00','d1an.00','d1am.00','d1al.00','d1a7.00','d1a6.00','d1b..00','d1b2.00','d1b1.00','d1b4.00','d1b3.00','do4..00','do41.00','do2..00','do2z.00','do21.00','do1..00','do1z.00','do1y.00','do1x.00','do1w.00','do1v.00','do1u.00','do1t.00','do1B.11','do1B.00','do1A.11','do1A.00','do19.11','do19.00','do18.11','do18.00','do17.00','do16.00','do15.00','do14.00','do13.00','do12.00','do11.00','o56z.00','o561.00','o57..00','o57z.00','o57y.00','o57w.00','o57v.00','o57u.00','o57t.00','o57s.00','o57r.00','o576.00','o575.00','o574.00','o573.00','o572.00','o571.00','o535.00','o534.00','o533.00','o532.00','o531.00','dnc..00','dnc1.00','dn4..00','dn4z.00','dn4y.00','dn4x.00','dn4w.00','dn42.00','dn41.00','d2b..','d2bz.','d2by.','d2b2.','d2b1.','d2a..','d2az.','d2a2.','d2a1.','d2ax.','d2a7.','d2a6.','d2a5.','d2a4.','d2a3.','d2d..','d2d4.','d2d3.','d2d2.','d2d1.','d2d7.','d2d6.','d2d5.','d2e..','d2ez.','d2e1.','d29..','d29z.','d29y.','d292.','d291.','d24..','d248.','d247.','d246.','d24j.','d24i.','d24h.','d24g.','d24f.','d24e.','d24d.','d24c.','d24b.','d24a.','d249.','d245.','d244.','d243.','d242.','d241.','d26..','d268.','d266.','d263.','d261.','d26A.','d269.','d267.','d265.','d264.','d262.','d27..','d27z.','d27y.','d272.','d271.','d21..','d21z.','d21J.','d21A.','d216.','d215.','d214.','d213.','d212.','d211.','d21y.','d21x.','d21w.','d21v.','d21u.','d21t.','d21s.','d21r.','d21q.','d21p.','d21o.','d21n.','d21m.','d21l.','d21k.','d21j.','d21i.','d21h.','d21g.','d21f.','d21e.','d21d.','d21c.','d21b.','d21a.','d21G.','d21F.','d21E.','d21D.','d21C.','d21B.','d219.','d218.','d217.','d23..','d23z.','d23y.','d232.','d231.','d22..','d22z.','d22y.','d222.','d221.','d14..','d14z.','d141.','d15..','d15z.','d15y.','d154.','d153.','d152.','d151.','d17..','d172.','d171.','d174.','d173.','d16..','d161.','d162.','d18..','d18f.','d184.','d183.','d182.','d181.','d18e.','d18d.','d18c.','d18b.','d18a.','d189.','d188.','d187.','d186.','d185.','d1a..','d1ao.','d1ak.','d1aj.','d1ai.','d1ah.','d1ag.','d1af.','d1ae.','d1ad.','d1ac.','d1ab.','d1aa.','d1a9.','d1a8.','d1a5.','d1a4.','d1a3.','d1a2.','d1a1.','d1an.','d1am.','d1al.','d1a7.','d1a6.','d1b..','d1b2.','d1b1.','d1b4.','d1b3.','do4..','do41.','do2..','do2z.','do21.','do1..','do1z.','do1y.','do1x.','do1w.','do1v.','do1u.','do1t.','do1B.','do1A.','do19.','do18.','do17.','do16.','do15.','do14.','do13.','do12.','do11.','o56z.','o561.','o57..','o57z.','o57y.','o57w.','o57v.','o57u.','o57t.','o57s.','o57r.','o576.','o575.','o574.','o573.','o572.','o571.','o535.','o534.','o533.','o532.','o531.','dnc..','dnc1.','dn4..','dn4z.','dn4y.','dn4x.','dn4w.','dn42.','dn41.')
	and EntryDate <= '2020-05-14'
	group by PatID
) sub 
where FirstDiagnosis >= '2015-01-01'
group by FirstDiagnosis

-- Populate prevalence table - count all occurrences of the 
-- code irrespective of whether it is the first time the patient has had it
select EntryDate, count(*) as num into #Prevalence from (
	select PatID, EntryDate from SIR_ALL_Records_Narrow
	where ReadCode in ('d2b..00','d2bz.00','d2by.00','d2b2.00','d2b1.00','d2a..00','d2az.00','d2a2.00','d2a1.00','d2ax.00','d2a7.00','d2a6.00','d2a5.00','d2a4.00','d2a3.00','d2d..00','d2d4.00','d2d3.00','d2d2.00','d2d1.00','d2d7.00','d2d6.00','d2d5.00','d2e..00','d2ez.00','d2e1.00','d29..00','d29z.00','d29y.00','d292.00','d291.00','d24..00','d248.00','d247.00','d246.00','d24j.00','d24i.00','d24h.00','d24g.00','d24f.00','d24e.00','d24d.00','d24c.00','d24b.00','d24a.00','d249.00','d245.00','d244.00','d243.00','d242.00','d242.11','d241.00','d241.11','d26..00','d268.00','d266.00','d263.00','d261.00','d26A.00','d269.00','d267.00','d265.00','d264.00','d262.00','d27..00','d27z.00','d27y.00','d272.00','d271.00','d21..00','d21z.00','d21J.00','d21A.00','d216.00','d215.00','d214.00','d213.00','d212.00','d211.00','d21y.00','d21x.00','d21w.00','d21v.00','d21u.00','d21t.00','d21s.00','d21r.00','d21q.00','d21p.00','d21o.00','d21n.00','d21m.00','d21l.00','d21k.00','d21j.00','d21i.00','d21h.00','d21g.00','d21f.00','d21e.00','d21d.00','d21c.00','d21b.00','d21a.00','d21G.00','d21F.00','d21E.00','d21D.00','d21C.00','d21B.00','d219.00','d218.00','d217.00','d23..00','d23z.00','d23y.00','d232.00','d231.00','d22..00','d22z.00','d22y.00','d222.00','d221.00','d14..00','d14z.00','d141.00','d15..00','d15z.00','d15y.00','d154.00','d153.00','d152.00','d151.00','d17..00','d172.00','d171.00','d174.00','d173.00','d16..00','d161.00','d162.00','d18..00','d18f.00','d184.00','d183.00','d182.00','d181.00','d18e.00','d18d.00','d18c.00','d18b.00','d18a.00','d189.00','d188.00','d187.00','d186.00','d185.00','d1a..00','d1ao.00','d1ak.00','d1aj.00','d1ai.00','d1ah.00','d1ag.00','d1af.00','d1ae.00','d1ad.00','d1ac.00','d1ab.00','d1aa.00','d1a9.00','d1a8.00','d1a5.00','d1a4.00','d1a3.00','d1a2.00','d1a1.00','d1an.00','d1am.00','d1al.00','d1a7.00','d1a6.00','d1b..00','d1b2.00','d1b1.00','d1b4.00','d1b3.00','do4..00','do41.00','do2..00','do2z.00','do21.00','do1..00','do1z.00','do1y.00','do1x.00','do1w.00','do1v.00','do1u.00','do1t.00','do1B.11','do1B.00','do1A.11','do1A.00','do19.11','do19.00','do18.11','do18.00','do17.00','do16.00','do15.00','do14.00','do13.00','do12.00','do11.00','o56z.00','o561.00','o57..00','o57z.00','o57y.00','o57w.00','o57v.00','o57u.00','o57t.00','o57s.00','o57r.00','o576.00','o575.00','o574.00','o573.00','o572.00','o571.00','o535.00','o534.00','o533.00','o532.00','o531.00','dnc..00','dnc1.00','dn4..00','dn4z.00','dn4y.00','dn4x.00','dn4w.00','dn42.00','dn41.00','d2b..','d2bz.','d2by.','d2b2.','d2b1.','d2a..','d2az.','d2a2.','d2a1.','d2ax.','d2a7.','d2a6.','d2a5.','d2a4.','d2a3.','d2d..','d2d4.','d2d3.','d2d2.','d2d1.','d2d7.','d2d6.','d2d5.','d2e..','d2ez.','d2e1.','d29..','d29z.','d29y.','d292.','d291.','d24..','d248.','d247.','d246.','d24j.','d24i.','d24h.','d24g.','d24f.','d24e.','d24d.','d24c.','d24b.','d24a.','d249.','d245.','d244.','d243.','d242.','d241.','d26..','d268.','d266.','d263.','d261.','d26A.','d269.','d267.','d265.','d264.','d262.','d27..','d27z.','d27y.','d272.','d271.','d21..','d21z.','d21J.','d21A.','d216.','d215.','d214.','d213.','d212.','d211.','d21y.','d21x.','d21w.','d21v.','d21u.','d21t.','d21s.','d21r.','d21q.','d21p.','d21o.','d21n.','d21m.','d21l.','d21k.','d21j.','d21i.','d21h.','d21g.','d21f.','d21e.','d21d.','d21c.','d21b.','d21a.','d21G.','d21F.','d21E.','d21D.','d21C.','d21B.','d219.','d218.','d217.','d23..','d23z.','d23y.','d232.','d231.','d22..','d22z.','d22y.','d222.','d221.','d14..','d14z.','d141.','d15..','d15z.','d15y.','d154.','d153.','d152.','d151.','d17..','d172.','d171.','d174.','d173.','d16..','d161.','d162.','d18..','d18f.','d184.','d183.','d182.','d181.','d18e.','d18d.','d18c.','d18b.','d18a.','d189.','d188.','d187.','d186.','d185.','d1a..','d1ao.','d1ak.','d1aj.','d1ai.','d1ah.','d1ag.','d1af.','d1ae.','d1ad.','d1ac.','d1ab.','d1aa.','d1a9.','d1a8.','d1a5.','d1a4.','d1a3.','d1a2.','d1a1.','d1an.','d1am.','d1al.','d1a7.','d1a6.','d1b..','d1b2.','d1b1.','d1b4.','d1b3.','do4..','do41.','do2..','do2z.','do21.','do1..','do1z.','do1y.','do1x.','do1w.','do1v.','do1u.','do1t.','do1B.','do1A.','do19.','do18.','do17.','do16.','do15.','do14.','do13.','do12.','do11.','o56z.','o561.','o57..','o57z.','o57y.','o57w.','o57v.','o57u.','o57t.','o57s.','o57r.','o576.','o575.','o574.','o573.','o572.','o571.','o535.','o534.','o533.','o532.','o531.','dnc..','dnc1.','dn4..','dn4z.','dn4y.','dn4x.','dn4w.','dn42.','dn41.')
	and EntryDate >= '2015-01-01'
	and EntryDate <= '2020-05-14'
	group by PatID, EntryDate
) sub 
group by EntryDate

PRINT 'Date,IncidenceOfBenzodiaepines,PrevalenceOfBenzodiaepines'
select [date], ISNULL(i.num, 0), ISNULL(p.num, 0) from #AllDates d 
	left outer join #Incidence i on i.FirstDiagnosis = d.date
	left outer join #Prevalence p on p.EntryDate = d.date
order by date;
