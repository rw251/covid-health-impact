-- Template for the groups of conditions
-- E.g. all malignant cancers, or all cvd

--Just want the output, not the messages
SET NOCOUNT ON; 

--populate table with all dates from 2015-01-01
IF OBJECT_ID('tempdb..#AllDates') IS NOT NULL DROP TABLE #AllDates;
CREATE TABLE #AllDates ([date] date);
declare @dt datetime = '2015-01-01'
declare @dtEnd datetime = '2020-05-29';
WHILE (@dt <= @dtEnd) BEGIN
    insert into #AllDates([date])
        values(@dt)
    SET @dt = DATEADD(day, 1, @dt)
END;

-- Populate incidence table - only count those occurrences
-- of the code where it is the first time the patient has had it
select FirstDiagnosis, count(*) as num into #Incidence from (
	-- other diabetes
select NHSNo, min(EntryDate) as FirstDiagnosis from journal
where ReadCode in ('C10..00','C10z.00','C10zz00','C10zy00','C10y.00','C10yz00','C10yy00','C10N.00','C10N100','C10N000','C10M.00','C10M000','C10H.00','C10H000','C10G.00','C10G000','C10FS00','C10ER00','C10B.00','C10B000','C10A.00','C10A.11','C10AX00','C10AW00','C10A700','C10A600','C10A500','C10A400','C10A300','C10A200','C10A100','C10A000','C108z00','C108y00','C107.00','C107.11','C107.12','C107z00','C107y00','C107200','C105.00','C105z00','C105y00','C103.00','C103z00','C103y00','C102.00','C102z00','C101.00','C101z00','C101y00','C100.00','C100z00','C100111','C106.00','C106z00','C106y00','C104.00','C104y00','C10Q.00','C10C.00','C10C.11','66AU.00','66AJ.11','66AJ100','Cyu2.00','Cyu2300','Cyu2200','Cyu2100','Cyu2000','8Hgd.00','C11y000','C314.11','C350011','PKyP.00','Kyu0300','C10..','C10z.','C10zz','C10zy','C10y.','C10yz','C10yy','C10N.','C10N1','C10N0','C10M.','C10M0','C10H.','C10H0','C10G.','C10G0','C10FS','C10ER','C10B.','C10B0','C10A.','C10AX','C10AW','C10A7','C10A6','C10A5','C10A4','C10A3','C10A2','C10A1','C10A0','C108z','C108y','C107.','C107z','C107y','C1072','C105.','C105z','C105y','C103.','C103z','C103y','C102.','C102z','C101.','C101z','C101y','C100.','C100z','C106.','C106z','C106y','C104.','C104y','C10Q.','C10C.','66AU.','66AJ1','Cyu2.','Cyu23','Cyu22','Cyu21','Cyu20','8Hgd.','C11y0','PKyP.','Kyu03')
and EntryDate <= '2020-05-29'
group by NHSNo
 UNION ALL 
-- t1dm
select NHSNo, min(EntryDate) as FirstDiagnosis from journal
where ReadCode in ('C10E.11','C10E.12','C10E.00','C10EQ11','C10EQ00','C10EP11','C10EP00','C10EN11','C10EN00','C10EM11','C10EM00','C10EL11','C10EL00','C10EK11','C10EK00','C10EJ11','C10EJ12','C10EJ00','C10EH11','C10EH12','C10EH00','C10EG11','C10EG12','C10EG00','C10EF11','C10EF12','C10EF00','C10EE11','C10EE12','C10EE00','C10ED11','C10ED12','C10ED00','C10EC11','C10EC12','C10EC00','C10EB11','C10EB12','C10EB00','C10EA11','C10EA12','C10EA00','C10E911','C10E912','C10E900','C10E811','C10E812','C10E800','C10E711','C10E712','C10E700','C10E611','C10E612','C10E600','C10E511','C10E512','C10E500','C10E411','C10E412','C10E400','C10E311','C10E312','C10E300','C10E211','C10E212','C10E200','C10E111','C10E112','C10E100','C10E011','C10E012','C10E000','C108.00','C108.11','C108.13','C108.12','C108J00','C108J11','C108J12','C108H00','C108H11','C108H12','C108G00','C108G11','C108G12','C108F00','C108F11','C108F12','C108E00','C108E11','C108E12','C108D00','C108D11','C108D12','C108C00','C108C11','C108C12','C108B00','C108B11','C108B12','C108A00','C108A11','C108A12','C108900','C108911','C108912','C108800','C108811','C108812','C108700','C108711','C108712','C108600','C108611','C108612','C108500','C108511','C108512','C108400','C108411','C108412','C108300','C108311','C108312','C108200','C108211','C108212','C108100','C108111','C108112','C108000','C108011','C108012','C100000','C100011','C101000','C102000','C103000','C104000','C105000','C106000','C107000','C10y000','C10z000','C10E.','C10EQ','C10EP','C10EN','C10EM','C10EL','C10EK','C10EJ','C10EH','C10EG','C10EF','C10EE','C10ED','C10EC','C10EB','C10EA','C10E9','C10E8','C10E7','C10E6','C10E5','C10E4','C10E3','C10E2','C10E1','C10E0','C108.','C108J','C108H','C108G','C108F','C108E','C108D','C108C','C108B','C108A','C1089','C1088','C1087','C1086','C1085','C1084','C1083','C1082','C1081','C1080','C1000','C1010','C1020','C1030','C1040','C1050','C1060','C1070','C10y0','C10z0')
and EntryDate <= '2020-05-29'
group by NHSNo
 UNION ALL 
-- t2dm
select NHSNo, min(EntryDate) as FirstDiagnosis from journal
where ReadCode in ('C10D.00','C10F.00','C10F.11','C10FR00','C10FR11','C10FQ00','C10FQ11','C10FP00','C10FP11','C10FN00','C10FN11','C10FM00','C10FM11','C10FL00','C10FL11','C10FK00','C10FK11','C10FJ00','C10FJ11','C10FH00','C10FH11','C10FG00','C10FG11','C10FF00','C10FF11','C10FE00','C10FE11','C10FD00','C10FD11','C10FC00','C10FC11','C10FB00','C10FB11','C10FA00','C10FA11','C10F900','C10F911','C10F700','C10F711','C10F600','C10F611','C10F500','C10F511','C10F400','C10F411','C10F300','C10F311','C10F200','C10F211','C10F100','C10F111','C10F000','C10F011','C109.00','C109.11','C109.12','C109.13','C109K00','C109J00','C109J11','C109J12','C109H00','C109H12','C109H11','C109G00','C109G12','C109G11','C109F00','C109F12','C109F11','C109E00','C109E12','C109E11','C109D00','C109D12','C109D11','C109C00','C109C12','C109C11','C109B00','C109B12','C109B11','C109A00','C109A12','C109A11','C109900','C109912','C109911','C109700','C109712','C109711','C109600','C109612','C109611','C109500','C109512','C109511','C109400','C109412','C109411','C109300','C109312','C109311','C109200','C109212','C109211','C109100','C109112','C109111','C109000','C109012','C109011','C100100','C100112','C101100','C102100','C103100','C104100','C105100','C106100','C107100','C10y100','C10z100','C10D.','C10F.','C10FR','C10FQ','C10FP','C10FN','C10FM','C10FL','C10FK','C10FJ','C10FH','C10FG','C10FF','C10FE','C10FD','C10FC','C10FB','C10FA','C10F9','C10F7','C10F6','C10F5','C10F4','C10F3','C10F2','C10F1','C10F0','C109.','C109K','C109J','C109H','C109G','C109F','C109E','C109D','C109C','C109B','C109A','C1099','C1097','C1096','C1095','C1094','C1093','C1092','C1091','C1090','C1001','C1011','C1021','C1031','C1041','C1051','C1061','C1071','C10y1','C10z1')
and EntryDate <= '2020-05-29'
group by NHSNo
) sub 
where FirstDiagnosis >= '2015-01-01'
group by FirstDiagnosis

-- Populate prevalence table - count all occurrences of the 
-- code irrespective of whether it is the first time the patient has had it
select EntryDate, count(*) as num into #Prevalence from (
	-- other diabetes
select PatID, EntryDate from SIR_ALL_Records_Narrow
where ReadCode in ('C10..00','C10z.00','C10zz00','C10zy00','C10y.00','C10yz00','C10yy00','C10N.00','C10N100','C10N000','C10M.00','C10M000','C10H.00','C10H000','C10G.00','C10G000','C10FS00','C10ER00','C10B.00','C10B000','C10A.00','C10A.11','C10AX00','C10AW00','C10A700','C10A600','C10A500','C10A400','C10A300','C10A200','C10A100','C10A000','C108z00','C108y00','C107.00','C107.11','C107.12','C107z00','C107y00','C107200','C105.00','C105z00','C105y00','C103.00','C103z00','C103y00','C102.00','C102z00','C101.00','C101z00','C101y00','C100.00','C100z00','C100111','C106.00','C106z00','C106y00','C104.00','C104y00','C10Q.00','C10C.00','C10C.11','66AU.00','66AJ.11','66AJ100','Cyu2.00','Cyu2300','Cyu2200','Cyu2100','Cyu2000','8Hgd.00','C11y000','C314.11','C350011','PKyP.00','Kyu0300','C10..','C10z.','C10zz','C10zy','C10y.','C10yz','C10yy','C10N.','C10N1','C10N0','C10M.','C10M0','C10H.','C10H0','C10G.','C10G0','C10FS','C10ER','C10B.','C10B0','C10A.','C10AX','C10AW','C10A7','C10A6','C10A5','C10A4','C10A3','C10A2','C10A1','C10A0','C108z','C108y','C107.','C107z','C107y','C1072','C105.','C105z','C105y','C103.','C103z','C103y','C102.','C102z','C101.','C101z','C101y','C100.','C100z','C106.','C106z','C106y','C104.','C104y','C10Q.','C10C.','66AU.','66AJ1','Cyu2.','Cyu23','Cyu22','Cyu21','Cyu20','8Hgd.','C11y0','PKyP.','Kyu03')
and EntryDate >= '2015-01-01'
and EntryDate <= '2020-05-29'
group by PatID, EntryDate
 UNION ALL 
-- t1dm
select PatID, EntryDate from SIR_ALL_Records_Narrow
where ReadCode in ('C10E.11','C10E.12','C10E.00','C10EQ11','C10EQ00','C10EP11','C10EP00','C10EN11','C10EN00','C10EM11','C10EM00','C10EL11','C10EL00','C10EK11','C10EK00','C10EJ11','C10EJ12','C10EJ00','C10EH11','C10EH12','C10EH00','C10EG11','C10EG12','C10EG00','C10EF11','C10EF12','C10EF00','C10EE11','C10EE12','C10EE00','C10ED11','C10ED12','C10ED00','C10EC11','C10EC12','C10EC00','C10EB11','C10EB12','C10EB00','C10EA11','C10EA12','C10EA00','C10E911','C10E912','C10E900','C10E811','C10E812','C10E800','C10E711','C10E712','C10E700','C10E611','C10E612','C10E600','C10E511','C10E512','C10E500','C10E411','C10E412','C10E400','C10E311','C10E312','C10E300','C10E211','C10E212','C10E200','C10E111','C10E112','C10E100','C10E011','C10E012','C10E000','C108.00','C108.11','C108.13','C108.12','C108J00','C108J11','C108J12','C108H00','C108H11','C108H12','C108G00','C108G11','C108G12','C108F00','C108F11','C108F12','C108E00','C108E11','C108E12','C108D00','C108D11','C108D12','C108C00','C108C11','C108C12','C108B00','C108B11','C108B12','C108A00','C108A11','C108A12','C108900','C108911','C108912','C108800','C108811','C108812','C108700','C108711','C108712','C108600','C108611','C108612','C108500','C108511','C108512','C108400','C108411','C108412','C108300','C108311','C108312','C108200','C108211','C108212','C108100','C108111','C108112','C108000','C108011','C108012','C100000','C100011','C101000','C102000','C103000','C104000','C105000','C106000','C107000','C10y000','C10z000','C10E.','C10EQ','C10EP','C10EN','C10EM','C10EL','C10EK','C10EJ','C10EH','C10EG','C10EF','C10EE','C10ED','C10EC','C10EB','C10EA','C10E9','C10E8','C10E7','C10E6','C10E5','C10E4','C10E3','C10E2','C10E1','C10E0','C108.','C108J','C108H','C108G','C108F','C108E','C108D','C108C','C108B','C108A','C1089','C1088','C1087','C1086','C1085','C1084','C1083','C1082','C1081','C1080','C1000','C1010','C1020','C1030','C1040','C1050','C1060','C1070','C10y0','C10z0')
and EntryDate >= '2015-01-01'
and EntryDate <= '2020-05-29'
group by PatID, EntryDate
 UNION ALL 
-- t2dm
select PatID, EntryDate from SIR_ALL_Records_Narrow
where ReadCode in ('C10D.00','C10F.00','C10F.11','C10FR00','C10FR11','C10FQ00','C10FQ11','C10FP00','C10FP11','C10FN00','C10FN11','C10FM00','C10FM11','C10FL00','C10FL11','C10FK00','C10FK11','C10FJ00','C10FJ11','C10FH00','C10FH11','C10FG00','C10FG11','C10FF00','C10FF11','C10FE00','C10FE11','C10FD00','C10FD11','C10FC00','C10FC11','C10FB00','C10FB11','C10FA00','C10FA11','C10F900','C10F911','C10F700','C10F711','C10F600','C10F611','C10F500','C10F511','C10F400','C10F411','C10F300','C10F311','C10F200','C10F211','C10F100','C10F111','C10F000','C10F011','C109.00','C109.11','C109.12','C109.13','C109K00','C109J00','C109J11','C109J12','C109H00','C109H12','C109H11','C109G00','C109G12','C109G11','C109F00','C109F12','C109F11','C109E00','C109E12','C109E11','C109D00','C109D12','C109D11','C109C00','C109C12','C109C11','C109B00','C109B12','C109B11','C109A00','C109A12','C109A11','C109900','C109912','C109911','C109700','C109712','C109711','C109600','C109612','C109611','C109500','C109512','C109511','C109400','C109412','C109411','C109300','C109312','C109311','C109200','C109212','C109211','C109100','C109112','C109111','C109000','C109012','C109011','C100100','C100112','C101100','C102100','C103100','C104100','C105100','C106100','C107100','C10y100','C10z100','C10D.','C10F.','C10FR','C10FQ','C10FP','C10FN','C10FM','C10FL','C10FK','C10FJ','C10FH','C10FG','C10FF','C10FE','C10FD','C10FC','C10FB','C10FA','C10F9','C10F7','C10F6','C10F5','C10F4','C10F3','C10F2','C10F1','C10F0','C109.','C109K','C109J','C109H','C109G','C109F','C109E','C109D','C109C','C109B','C109A','C1099','C1097','C1096','C1095','C1094','C1093','C1092','C1091','C1090','C1001','C1011','C1021','C1031','C1041','C1051','C1061','C1071','C10y1','C10z1')
and EntryDate >= '2015-01-01'
and EntryDate <= '2020-05-29'
group by PatID, EntryDate
) sub 
group by EntryDate

PRINT 'Date,IncidenceOfDiabetes,PrevalenceOfDiabetes'
select [date], ISNULL(i.num, 0), ISNULL(p.num, 0) from #AllDates d 
	left outer join #Incidence i on i.FirstDiagnosis = d.date
	left outer join #Prevalence p on p.EntryDate = d.date
order by date;
