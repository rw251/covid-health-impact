--Just want the output, not the messages
SET NOCOUNT ON; 

--populate table with all dates from 2015-01-01
IF OBJECT_ID('tempdb..#AllDates') IS NOT NULL DROP TABLE #AllDates;
CREATE TABLE #AllDates ([date] date);
declare @dt datetime = '2015-01-01'
declare @dtEnd datetime = '2020-05-14';
WHILE (@dt <= @dtEnd) BEGIN
    insert into #AllDates([date])
        values(@dt)
    SET @dt = DATEADD(day, 1, @dt)
END;

-- Populate incidence table - only count those occurrences
-- of the code where it is the first time the patient has had it
select FirstDiagnosis, count(*) as num into #Incidence from (
	select PatID, min(EntryDate) as FirstDiagnosis from SIR_ALL_Records_Narrow
	where ReadCode in ('d4n..00','d4n4.00','d4n3.00','d4n2.00','d4n1.00','d4j..00','d4jz.00','d4jy.00','d4jx.00','d4j3.00','d4j2.00','d4j1.00','d4u..00','d4u3.00','d4u2.00','d4u1.00','d4u6.00','d4u5.00','d4u4.00','d4i..00','d4iz.00','d4iy.00','d4i2.00','d4i1.00','d4h..00','d4hz.00','d4hy.00','d4hx.00','d4hw.00','d4hv.00','d4hu.00','d4ht.00','d4hs.00','d4hr.00','d4h9.00','d4hA.00','d4h8.00','d4h7.00','d4h6.00','d4h5.00','d4h4.00','d4h3.00','d4h2.00','d4h1.00','d4g..00','d4gz.00','d4gy.00','d4gx.00','d4gw.00','d4gv.00','d4gu.00','d4gt.00','d4gs.00','d4gr.00','d4gq.00','d4gp.00','d4g7.00','d4g6.00','d4g5.00','d4g4.00','d4g3.00','d4g2.00','d4g1.00','d4f..00','d4fz.00','d4fy.00','d4fx.00','d4fw.00','d4f6.00','d4f5.00','d4f4.00','d4f3.00','d4f2.00','d4f1.00','d4q..00','d4q4.00','d4q3.00','d4q2.00','d4q1.00','d4q8.00','d4q7.00','d4q6.00','d4q5.00','d4p..00','d4pz.00','d4py.00','d4px.00','d4pw.00','d4pS.00','d4pR.00','d4pQ.00','d4pM.00','d4pJ.00','d4pH.00','d4pB.00','d4p9.00','d4p4.00','d4p3.00','d4p2.00','d4p1.00','d4pP.00','d4pO.00','d4pN.00','d4pL.00','d4pK.00','d4pG.00','d4pF.00','d4pE.00','d4pD.00','d4pC.00','d4pA.00','d4p8.00','d4p7.00','d4p6.00','d4p5.00','d4m..00','d4m2.00','d4m1.00','d4m4.00','d4m3.00','d4s..00','d4sz.00','d4sy.00','d4sx.00','d4sw.00','d4sv.00','d4su.00','d4st.00','d4ss.00','d4s4.00','d4s3.00','d4s2.00','d4s1.00','d4sp.00','d4so.00','d4sn.00','d4sm.00','d4sl.00','d4sk.00','d4sj.00','d4si.00','d4sh.00','d4sg.00','d4sf.00','d4se.00','d4sd.00','d4sc.00','d4sb.00','d4sa.00','d4sZ.00','d4sY.00','d4sX.00','d4sW.00','d4sV.00','d4sU.00','d4sT.00','d4sS.00','d4sR.00','d4sQ.00','d4sP.00','d4sO.00','d4sN.00','d4sM.00','d4sL.00','d4sK.00','d4sJ.00','d4sI.00','d4sH.00','d4sG.00','d4sF.00','d4sE.00','d4sD.00','d4sC.00','d4sB.00','d4sA.00','d4s9.00','d4s8.00','d4s7.00','d4s6.00','d4s5.00','d4e..00','d4ez.00','d4ey.00','d4ex.00','d4ew.00','d4ev.00','d4e5.00','d4e4.00','d4e3.00','d4e2.00','d4e1.00','d4d..00','d4c..00','d4cz.00','d4cy.00','d4cx.00','d4c3.00','d4c2.00','d4c1.00','d4b..00','d4bz.00','d4by.00','d4bx.00','d4b6.00','d4b5.00','d4b4.00','d4b3.00','d4b2.00','d4b1.00','d4a..00','d4az.00','d4ay.00','d4ax.00','d4aw.00','d4a4.00','d4a3.00','d4a2.00','d4a1.00','d4w..00','d4wz.00','d4wy.00','d4wx.00','d4ww.00','d4wv.00','d4wu.00','d4wt.00','d4ws.00','d4wr.00','d4w9.00','d4w8.00','d4w7.00','d4w6.00','d4w5.00','d4w4.00','d4w3.00','d4w2.00','d4w1.00','d49..00','d49z.00','d49y.00','d492.00','d491.00','d4r..00','d4rz.00','d4ry.00','d4rx.00','d4rw.00','d4rv.00','d4ru.00','d4rt.00','d4r7.00','d4r3.00','d4r2.00','d4r1.00','d4rP.00','d4rO.00','d4rN.00','d4rM.00','d4rL.00','d4rK.00','d4rJ.00','d4rI.00','d4rH.00','d4rG.00','d4rF.00','d4rE.00','d4rD.00','d4rC.00','d4rB.00','d4rA.00','d4r9.00','d4r8.00','d4r6.00','d4r5.00','d4r4.00','d4y..00','d4y6.00','d4y4.00','d4y2.00','d4y5.00','d4y3.00','d4y1.00','d4k..00','d4k3.00','d4k2.00','d4k1.00','d4k6.00','d4k5.00','d4k4.00','d48..11','d48..00','d48z.11','d48z.00','d48y.11','d48y.00','d483.00','d482.00','d481.00','d47..00','d47y.00','d47x.00','d47w.00','d47v.00','d47u.00','d47t.00','d47r.00','d47B.00','d47A.00','d475.00','d474.00','d473.00','d472.00','d471.00','d47s.00','d47q.00','d47p.00','d47o.00','d47n.00','d47m.00','d47l.00','d47k.00','d47j.00','d47i.00','d47h.00','d47g.00','d47f.00','d47e.00','d47d.00','d47c.00','d47b.00','d47a.00','d47F.00','d47E.00','d47D.00','d47C.00','d479.00','d478.00','d477.00','d476.00','d46..00','d46z.00','d46y.00','d46x.00','d463.00','d462.00','d461.00','d45..11','d45..00','d45z.11','d45z.00','d451.00','d44..00','d44..11','d44z.00','d44y.00','d44x.00','d44w.00','d444.00','d443.00','d442.00','d441.00','d4l..00','d4lG.00','d4lE.00','d4lC.00','d4l2.00','d4l1.00','d4lF.00','d4lD.00','d4lB.00','d4lA.00','d4l9.00','d4l8.00','d4l7.00','d4l6.00','d4l5.00','d4l4.00','d4l3.00','d43..00','d43z.00','d43y.00','d432.00','d431.00','d41..00','d41o.00','d41m.00','d41l.00','d41k.00','d41j.00','d41B.00','d41A.00','d415.00','d414.00','d413.00','d412.00','d411.00','d41i.00','d41h.00','d41g.00','d41f.00','d41e.00','d41d.00','d41c.00','d41b.00','d41a.00','d419.00','d418.00','d417.00','d416.00','d42..00','d42z.00','d422.00','d421.00','d4x..00','d4x4.00','d4x2.00','d4x3.00','d4x1.00','d4v..00','d4vz.00','d4vy.00','d4vx.00','d4vw.00','d4vv.00','d4vu.00','d4vt.00','d4vs.00','d4vr.00','d4v9.00','d4v8.00','d4v7.00','d4v6.00','d4v5.00','d4v4.00','d4v3.00','d4v2.00','d4v1.00','d4t..00','d4tz.00','d4ty.00','d4tx.00','d4t2.00','d4t1.00','d4t7.00','d4t6.00','d4t5.00','d4t4.00','d4t3.00','d57..00','d57z.00','d57y.00','d578.00','d577.00','d576.00','d575.00','d574.00','d573.00','d572.00','d571.00','d56..11','d56..00','d564.11','d564.00','d563.11','d563.00','d562.00','d561.00','d58..00','d58z.00','d58y.00','d58x.00','d583.00','d582.00','d581.00','d55..00','d554.00','d553.00','d552.00','d551.00','d54..00','d546.00','d545.00','d544.00','d543.00','d542.00','d541.00','d53..00','d532.00','d531.00','d52..00','d52x.00','d52w.00','d52v.00','d52u.00','d52t.00','d52s.00','d52a.00','d529.00','d528.00','d527.00','d526.00','d525.00','d524.00','d523.00','d522.00','d521.00','d52C.00','d52B.00','d52A.00','d51..11','d51..00','d51z.00','d51y.11','d51y.00','d51x.00','d51w.11','d51w.00','d51v.11','d51v.00','d51u.11','d51u.00','d51t.00','d51s.00','d519.11','d519.00','d51a.00','d518.00','d517.00','d516.00','d515.00','d514.00','d513.00','d512.00','d511.00','d71..00','d71z.00','d71y.00','d71w.00','d71v.00','d71u.00','d71j.00','d71i.00','d71h.00','d713.00','d712.00','d711.00','d71g.00','d71f.00','d71e.00','d71d.00','d71c.00','d71b.00','d71a.00','d719.00','d718.00','d717.00','d716.00','d715.00','d714.00','d7c..00','d7cy.00','d7c9.00','d7c8.00','d7c7.00','d7c6.00','d7c5.00','d7c4.00','d7c3.00','d7c2.00','d7c1.00','dhi..00','dhe..00','dhez.00','dhey.00','dhex.00','dhew.00','dhev.00','dheu.00','dhet.00','dhes.00','dher.00','dhed.00','dhec.00','dheb.00','dhea.00','dheB.00','dheA.00','dhe9.00','dhe8.00','dhe7.00','dhe6.00','dhe5.00','dhe4.00','dhe3.00','dhe2.00','dhe1.00','dh2..00','o58..00','o58z.00','o581.00','o54..00','o541.00','o52..00','o52z.00','o52y.00','o522.00','o521.00','da1..11','da1..00','da1z.11','da1z.00','da1y.11','da1y.00','da12.00','da11.00','d915.00','d917.00','d916.00','d914.00','d913.00','d84..00','d84z.00','d841.00','dj26.00','dj24.00','o42w.00','ds1..00','dhg2.00','d4n..','d4n4.','d4n3.','d4n2.','d4n1.','d4j..','d4jz.','d4jy.','d4jx.','d4j3.','d4j2.','d4j1.','d4u..','d4u3.','d4u2.','d4u1.','d4u6.','d4u5.','d4u4.','d4i..','d4iz.','d4iy.','d4i2.','d4i1.','d4h..','d4hz.','d4hy.','d4hx.','d4hw.','d4hv.','d4hu.','d4ht.','d4hs.','d4hr.','d4h9.','d4hA.','d4h8.','d4h7.','d4h6.','d4h5.','d4h4.','d4h3.','d4h2.','d4h1.','d4g..','d4gz.','d4gy.','d4gx.','d4gw.','d4gv.','d4gu.','d4gt.','d4gs.','d4gr.','d4gq.','d4gp.','d4g7.','d4g6.','d4g5.','d4g4.','d4g3.','d4g2.','d4g1.','d4f..','d4fz.','d4fy.','d4fx.','d4fw.','d4f6.','d4f5.','d4f4.','d4f3.','d4f2.','d4f1.','d4q..','d4q4.','d4q3.','d4q2.','d4q1.','d4q8.','d4q7.','d4q6.','d4q5.','d4p..','d4pz.','d4py.','d4px.','d4pw.','d4pS.','d4pR.','d4pQ.','d4pM.','d4pJ.','d4pH.','d4pB.','d4p9.','d4p4.','d4p3.','d4p2.','d4p1.','d4pP.','d4pO.','d4pN.','d4pL.','d4pK.','d4pG.','d4pF.','d4pE.','d4pD.','d4pC.','d4pA.','d4p8.','d4p7.','d4p6.','d4p5.','d4m..','d4m2.','d4m1.','d4m4.','d4m3.','d4s..','d4sz.','d4sy.','d4sx.','d4sw.','d4sv.','d4su.','d4st.','d4ss.','d4s4.','d4s3.','d4s2.','d4s1.','d4sp.','d4so.','d4sn.','d4sm.','d4sl.','d4sk.','d4sj.','d4si.','d4sh.','d4sg.','d4sf.','d4se.','d4sd.','d4sc.','d4sb.','d4sa.','d4sZ.','d4sY.','d4sX.','d4sW.','d4sV.','d4sU.','d4sT.','d4sS.','d4sR.','d4sQ.','d4sP.','d4sO.','d4sN.','d4sM.','d4sL.','d4sK.','d4sJ.','d4sI.','d4sH.','d4sG.','d4sF.','d4sE.','d4sD.','d4sC.','d4sB.','d4sA.','d4s9.','d4s8.','d4s7.','d4s6.','d4s5.','d4e..','d4ez.','d4ey.','d4ex.','d4ew.','d4ev.','d4e5.','d4e4.','d4e3.','d4e2.','d4e1.','d4d..','d4c..','d4cz.','d4cy.','d4cx.','d4c3.','d4c2.','d4c1.','d4b..','d4bz.','d4by.','d4bx.','d4b6.','d4b5.','d4b4.','d4b3.','d4b2.','d4b1.','d4a..','d4az.','d4ay.','d4ax.','d4aw.','d4a4.','d4a3.','d4a2.','d4a1.','d4w..','d4wz.','d4wy.','d4wx.','d4ww.','d4wv.','d4wu.','d4wt.','d4ws.','d4wr.','d4w9.','d4w8.','d4w7.','d4w6.','d4w5.','d4w4.','d4w3.','d4w2.','d4w1.','d49..','d49z.','d49y.','d492.','d491.','d4r..','d4rz.','d4ry.','d4rx.','d4rw.','d4rv.','d4ru.','d4rt.','d4r7.','d4r3.','d4r2.','d4r1.','d4rP.','d4rO.','d4rN.','d4rM.','d4rL.','d4rK.','d4rJ.','d4rI.','d4rH.','d4rG.','d4rF.','d4rE.','d4rD.','d4rC.','d4rB.','d4rA.','d4r9.','d4r8.','d4r6.','d4r5.','d4r4.','d4y..','d4y6.','d4y4.','d4y2.','d4y5.','d4y3.','d4y1.','d4k..','d4k3.','d4k2.','d4k1.','d4k6.','d4k5.','d4k4.','d48..','d48z.','d48y.','d483.','d482.','d481.','d47..','d47y.','d47x.','d47w.','d47v.','d47u.','d47t.','d47r.','d47B.','d47A.','d475.','d474.','d473.','d472.','d471.','d47s.','d47q.','d47p.','d47o.','d47n.','d47m.','d47l.','d47k.','d47j.','d47i.','d47h.','d47g.','d47f.','d47e.','d47d.','d47c.','d47b.','d47a.','d47F.','d47E.','d47D.','d47C.','d479.','d478.','d477.','d476.','d46..','d46z.','d46y.','d46x.','d463.','d462.','d461.','d45..','d45z.','d451.','d44..','d44z.','d44y.','d44x.','d44w.','d444.','d443.','d442.','d441.','d4l..','d4lG.','d4lE.','d4lC.','d4l2.','d4l1.','d4lF.','d4lD.','d4lB.','d4lA.','d4l9.','d4l8.','d4l7.','d4l6.','d4l5.','d4l4.','d4l3.','d43..','d43z.','d43y.','d432.','d431.','d41..','d41o.','d41m.','d41l.','d41k.','d41j.','d41B.','d41A.','d415.','d414.','d413.','d412.','d411.','d41i.','d41h.','d41g.','d41f.','d41e.','d41d.','d41c.','d41b.','d41a.','d419.','d418.','d417.','d416.','d42..','d42z.','d422.','d421.','d4x..','d4x4.','d4x2.','d4x3.','d4x1.','d4v..','d4vz.','d4vy.','d4vx.','d4vw.','d4vv.','d4vu.','d4vt.','d4vs.','d4vr.','d4v9.','d4v8.','d4v7.','d4v6.','d4v5.','d4v4.','d4v3.','d4v2.','d4v1.','d4t..','d4tz.','d4ty.','d4tx.','d4t2.','d4t1.','d4t7.','d4t6.','d4t5.','d4t4.','d4t3.','d57..','d57z.','d57y.','d578.','d577.','d576.','d575.','d574.','d573.','d572.','d571.','d56..','d564.','d563.','d562.','d561.','d58..','d58z.','d58y.','d58x.','d583.','d582.','d581.','d55..','d554.','d553.','d552.','d551.','d54..','d546.','d545.','d544.','d543.','d542.','d541.','d53..','d532.','d531.','d52..','d52x.','d52w.','d52v.','d52u.','d52t.','d52s.','d52a.','d529.','d528.','d527.','d526.','d525.','d524.','d523.','d522.','d521.','d52C.','d52B.','d52A.','d51..','d51z.','d51y.','d51x.','d51w.','d51v.','d51u.','d51t.','d51s.','d519.','d51a.','d518.','d517.','d516.','d515.','d514.','d513.','d512.','d511.','d71..','d71z.','d71y.','d71w.','d71v.','d71u.','d71j.','d71i.','d71h.','d713.','d712.','d711.','d71g.','d71f.','d71e.','d71d.','d71c.','d71b.','d71a.','d719.','d718.','d717.','d716.','d715.','d714.','d7c..','d7cy.','d7c9.','d7c8.','d7c7.','d7c6.','d7c5.','d7c4.','d7c3.','d7c2.','d7c1.','dhi..','dhe..','dhez.','dhey.','dhex.','dhew.','dhev.','dheu.','dhet.','dhes.','dher.','dhed.','dhec.','dheb.','dhea.','dheB.','dheA.','dhe9.','dhe8.','dhe7.','dhe6.','dhe5.','dhe4.','dhe3.','dhe2.','dhe1.','dh2..','o58..','o58z.','o581.','o54..','o541.','o52..','o52z.','o52y.','o522.','o521.','da1..','da1z.','da1y.','da12.','da11.','d915.','d917.','d916.','d914.','d913.','d84..','d84z.','d841.','dj26.','dj24.','o42w.','ds1..','dhg2.')
	and EntryDate <= '2020-05-14'
	group by PatID
) sub 
where FirstDiagnosis >= '2015-01-01'
group by FirstDiagnosis

-- Populate prevalence table - count all occurrences of the 
-- code irrespective of whether it is the first time the patient has had it
select EntryDate, count(*) as num into #Prevalence from (
	select PatID, EntryDate from SIR_ALL_Records_Narrow
	where ReadCode in ('d4n..00','d4n4.00','d4n3.00','d4n2.00','d4n1.00','d4j..00','d4jz.00','d4jy.00','d4jx.00','d4j3.00','d4j2.00','d4j1.00','d4u..00','d4u3.00','d4u2.00','d4u1.00','d4u6.00','d4u5.00','d4u4.00','d4i..00','d4iz.00','d4iy.00','d4i2.00','d4i1.00','d4h..00','d4hz.00','d4hy.00','d4hx.00','d4hw.00','d4hv.00','d4hu.00','d4ht.00','d4hs.00','d4hr.00','d4h9.00','d4hA.00','d4h8.00','d4h7.00','d4h6.00','d4h5.00','d4h4.00','d4h3.00','d4h2.00','d4h1.00','d4g..00','d4gz.00','d4gy.00','d4gx.00','d4gw.00','d4gv.00','d4gu.00','d4gt.00','d4gs.00','d4gr.00','d4gq.00','d4gp.00','d4g7.00','d4g6.00','d4g5.00','d4g4.00','d4g3.00','d4g2.00','d4g1.00','d4f..00','d4fz.00','d4fy.00','d4fx.00','d4fw.00','d4f6.00','d4f5.00','d4f4.00','d4f3.00','d4f2.00','d4f1.00','d4q..00','d4q4.00','d4q3.00','d4q2.00','d4q1.00','d4q8.00','d4q7.00','d4q6.00','d4q5.00','d4p..00','d4pz.00','d4py.00','d4px.00','d4pw.00','d4pS.00','d4pR.00','d4pQ.00','d4pM.00','d4pJ.00','d4pH.00','d4pB.00','d4p9.00','d4p4.00','d4p3.00','d4p2.00','d4p1.00','d4pP.00','d4pO.00','d4pN.00','d4pL.00','d4pK.00','d4pG.00','d4pF.00','d4pE.00','d4pD.00','d4pC.00','d4pA.00','d4p8.00','d4p7.00','d4p6.00','d4p5.00','d4m..00','d4m2.00','d4m1.00','d4m4.00','d4m3.00','d4s..00','d4sz.00','d4sy.00','d4sx.00','d4sw.00','d4sv.00','d4su.00','d4st.00','d4ss.00','d4s4.00','d4s3.00','d4s2.00','d4s1.00','d4sp.00','d4so.00','d4sn.00','d4sm.00','d4sl.00','d4sk.00','d4sj.00','d4si.00','d4sh.00','d4sg.00','d4sf.00','d4se.00','d4sd.00','d4sc.00','d4sb.00','d4sa.00','d4sZ.00','d4sY.00','d4sX.00','d4sW.00','d4sV.00','d4sU.00','d4sT.00','d4sS.00','d4sR.00','d4sQ.00','d4sP.00','d4sO.00','d4sN.00','d4sM.00','d4sL.00','d4sK.00','d4sJ.00','d4sI.00','d4sH.00','d4sG.00','d4sF.00','d4sE.00','d4sD.00','d4sC.00','d4sB.00','d4sA.00','d4s9.00','d4s8.00','d4s7.00','d4s6.00','d4s5.00','d4e..00','d4ez.00','d4ey.00','d4ex.00','d4ew.00','d4ev.00','d4e5.00','d4e4.00','d4e3.00','d4e2.00','d4e1.00','d4d..00','d4c..00','d4cz.00','d4cy.00','d4cx.00','d4c3.00','d4c2.00','d4c1.00','d4b..00','d4bz.00','d4by.00','d4bx.00','d4b6.00','d4b5.00','d4b4.00','d4b3.00','d4b2.00','d4b1.00','d4a..00','d4az.00','d4ay.00','d4ax.00','d4aw.00','d4a4.00','d4a3.00','d4a2.00','d4a1.00','d4w..00','d4wz.00','d4wy.00','d4wx.00','d4ww.00','d4wv.00','d4wu.00','d4wt.00','d4ws.00','d4wr.00','d4w9.00','d4w8.00','d4w7.00','d4w6.00','d4w5.00','d4w4.00','d4w3.00','d4w2.00','d4w1.00','d49..00','d49z.00','d49y.00','d492.00','d491.00','d4r..00','d4rz.00','d4ry.00','d4rx.00','d4rw.00','d4rv.00','d4ru.00','d4rt.00','d4r7.00','d4r3.00','d4r2.00','d4r1.00','d4rP.00','d4rO.00','d4rN.00','d4rM.00','d4rL.00','d4rK.00','d4rJ.00','d4rI.00','d4rH.00','d4rG.00','d4rF.00','d4rE.00','d4rD.00','d4rC.00','d4rB.00','d4rA.00','d4r9.00','d4r8.00','d4r6.00','d4r5.00','d4r4.00','d4y..00','d4y6.00','d4y4.00','d4y2.00','d4y5.00','d4y3.00','d4y1.00','d4k..00','d4k3.00','d4k2.00','d4k1.00','d4k6.00','d4k5.00','d4k4.00','d48..11','d48..00','d48z.11','d48z.00','d48y.11','d48y.00','d483.00','d482.00','d481.00','d47..00','d47y.00','d47x.00','d47w.00','d47v.00','d47u.00','d47t.00','d47r.00','d47B.00','d47A.00','d475.00','d474.00','d473.00','d472.00','d471.00','d47s.00','d47q.00','d47p.00','d47o.00','d47n.00','d47m.00','d47l.00','d47k.00','d47j.00','d47i.00','d47h.00','d47g.00','d47f.00','d47e.00','d47d.00','d47c.00','d47b.00','d47a.00','d47F.00','d47E.00','d47D.00','d47C.00','d479.00','d478.00','d477.00','d476.00','d46..00','d46z.00','d46y.00','d46x.00','d463.00','d462.00','d461.00','d45..11','d45..00','d45z.11','d45z.00','d451.00','d44..00','d44..11','d44z.00','d44y.00','d44x.00','d44w.00','d444.00','d443.00','d442.00','d441.00','d4l..00','d4lG.00','d4lE.00','d4lC.00','d4l2.00','d4l1.00','d4lF.00','d4lD.00','d4lB.00','d4lA.00','d4l9.00','d4l8.00','d4l7.00','d4l6.00','d4l5.00','d4l4.00','d4l3.00','d43..00','d43z.00','d43y.00','d432.00','d431.00','d41..00','d41o.00','d41m.00','d41l.00','d41k.00','d41j.00','d41B.00','d41A.00','d415.00','d414.00','d413.00','d412.00','d411.00','d41i.00','d41h.00','d41g.00','d41f.00','d41e.00','d41d.00','d41c.00','d41b.00','d41a.00','d419.00','d418.00','d417.00','d416.00','d42..00','d42z.00','d422.00','d421.00','d4x..00','d4x4.00','d4x2.00','d4x3.00','d4x1.00','d4v..00','d4vz.00','d4vy.00','d4vx.00','d4vw.00','d4vv.00','d4vu.00','d4vt.00','d4vs.00','d4vr.00','d4v9.00','d4v8.00','d4v7.00','d4v6.00','d4v5.00','d4v4.00','d4v3.00','d4v2.00','d4v1.00','d4t..00','d4tz.00','d4ty.00','d4tx.00','d4t2.00','d4t1.00','d4t7.00','d4t6.00','d4t5.00','d4t4.00','d4t3.00','d57..00','d57z.00','d57y.00','d578.00','d577.00','d576.00','d575.00','d574.00','d573.00','d572.00','d571.00','d56..11','d56..00','d564.11','d564.00','d563.11','d563.00','d562.00','d561.00','d58..00','d58z.00','d58y.00','d58x.00','d583.00','d582.00','d581.00','d55..00','d554.00','d553.00','d552.00','d551.00','d54..00','d546.00','d545.00','d544.00','d543.00','d542.00','d541.00','d53..00','d532.00','d531.00','d52..00','d52x.00','d52w.00','d52v.00','d52u.00','d52t.00','d52s.00','d52a.00','d529.00','d528.00','d527.00','d526.00','d525.00','d524.00','d523.00','d522.00','d521.00','d52C.00','d52B.00','d52A.00','d51..11','d51..00','d51z.00','d51y.11','d51y.00','d51x.00','d51w.11','d51w.00','d51v.11','d51v.00','d51u.11','d51u.00','d51t.00','d51s.00','d519.11','d519.00','d51a.00','d518.00','d517.00','d516.00','d515.00','d514.00','d513.00','d512.00','d511.00','d71..00','d71z.00','d71y.00','d71w.00','d71v.00','d71u.00','d71j.00','d71i.00','d71h.00','d713.00','d712.00','d711.00','d71g.00','d71f.00','d71e.00','d71d.00','d71c.00','d71b.00','d71a.00','d719.00','d718.00','d717.00','d716.00','d715.00','d714.00','d7c..00','d7cy.00','d7c9.00','d7c8.00','d7c7.00','d7c6.00','d7c5.00','d7c4.00','d7c3.00','d7c2.00','d7c1.00','dhi..00','dhe..00','dhez.00','dhey.00','dhex.00','dhew.00','dhev.00','dheu.00','dhet.00','dhes.00','dher.00','dhed.00','dhec.00','dheb.00','dhea.00','dheB.00','dheA.00','dhe9.00','dhe8.00','dhe7.00','dhe6.00','dhe5.00','dhe4.00','dhe3.00','dhe2.00','dhe1.00','dh2..00','o58..00','o58z.00','o581.00','o54..00','o541.00','o52..00','o52z.00','o52y.00','o522.00','o521.00','da1..11','da1..00','da1z.11','da1z.00','da1y.11','da1y.00','da12.00','da11.00','d915.00','d917.00','d916.00','d914.00','d913.00','d84..00','d84z.00','d841.00','dj26.00','dj24.00','o42w.00','ds1..00','dhg2.00','d4n..','d4n4.','d4n3.','d4n2.','d4n1.','d4j..','d4jz.','d4jy.','d4jx.','d4j3.','d4j2.','d4j1.','d4u..','d4u3.','d4u2.','d4u1.','d4u6.','d4u5.','d4u4.','d4i..','d4iz.','d4iy.','d4i2.','d4i1.','d4h..','d4hz.','d4hy.','d4hx.','d4hw.','d4hv.','d4hu.','d4ht.','d4hs.','d4hr.','d4h9.','d4hA.','d4h8.','d4h7.','d4h6.','d4h5.','d4h4.','d4h3.','d4h2.','d4h1.','d4g..','d4gz.','d4gy.','d4gx.','d4gw.','d4gv.','d4gu.','d4gt.','d4gs.','d4gr.','d4gq.','d4gp.','d4g7.','d4g6.','d4g5.','d4g4.','d4g3.','d4g2.','d4g1.','d4f..','d4fz.','d4fy.','d4fx.','d4fw.','d4f6.','d4f5.','d4f4.','d4f3.','d4f2.','d4f1.','d4q..','d4q4.','d4q3.','d4q2.','d4q1.','d4q8.','d4q7.','d4q6.','d4q5.','d4p..','d4pz.','d4py.','d4px.','d4pw.','d4pS.','d4pR.','d4pQ.','d4pM.','d4pJ.','d4pH.','d4pB.','d4p9.','d4p4.','d4p3.','d4p2.','d4p1.','d4pP.','d4pO.','d4pN.','d4pL.','d4pK.','d4pG.','d4pF.','d4pE.','d4pD.','d4pC.','d4pA.','d4p8.','d4p7.','d4p6.','d4p5.','d4m..','d4m2.','d4m1.','d4m4.','d4m3.','d4s..','d4sz.','d4sy.','d4sx.','d4sw.','d4sv.','d4su.','d4st.','d4ss.','d4s4.','d4s3.','d4s2.','d4s1.','d4sp.','d4so.','d4sn.','d4sm.','d4sl.','d4sk.','d4sj.','d4si.','d4sh.','d4sg.','d4sf.','d4se.','d4sd.','d4sc.','d4sb.','d4sa.','d4sZ.','d4sY.','d4sX.','d4sW.','d4sV.','d4sU.','d4sT.','d4sS.','d4sR.','d4sQ.','d4sP.','d4sO.','d4sN.','d4sM.','d4sL.','d4sK.','d4sJ.','d4sI.','d4sH.','d4sG.','d4sF.','d4sE.','d4sD.','d4sC.','d4sB.','d4sA.','d4s9.','d4s8.','d4s7.','d4s6.','d4s5.','d4e..','d4ez.','d4ey.','d4ex.','d4ew.','d4ev.','d4e5.','d4e4.','d4e3.','d4e2.','d4e1.','d4d..','d4c..','d4cz.','d4cy.','d4cx.','d4c3.','d4c2.','d4c1.','d4b..','d4bz.','d4by.','d4bx.','d4b6.','d4b5.','d4b4.','d4b3.','d4b2.','d4b1.','d4a..','d4az.','d4ay.','d4ax.','d4aw.','d4a4.','d4a3.','d4a2.','d4a1.','d4w..','d4wz.','d4wy.','d4wx.','d4ww.','d4wv.','d4wu.','d4wt.','d4ws.','d4wr.','d4w9.','d4w8.','d4w7.','d4w6.','d4w5.','d4w4.','d4w3.','d4w2.','d4w1.','d49..','d49z.','d49y.','d492.','d491.','d4r..','d4rz.','d4ry.','d4rx.','d4rw.','d4rv.','d4ru.','d4rt.','d4r7.','d4r3.','d4r2.','d4r1.','d4rP.','d4rO.','d4rN.','d4rM.','d4rL.','d4rK.','d4rJ.','d4rI.','d4rH.','d4rG.','d4rF.','d4rE.','d4rD.','d4rC.','d4rB.','d4rA.','d4r9.','d4r8.','d4r6.','d4r5.','d4r4.','d4y..','d4y6.','d4y4.','d4y2.','d4y5.','d4y3.','d4y1.','d4k..','d4k3.','d4k2.','d4k1.','d4k6.','d4k5.','d4k4.','d48..','d48z.','d48y.','d483.','d482.','d481.','d47..','d47y.','d47x.','d47w.','d47v.','d47u.','d47t.','d47r.','d47B.','d47A.','d475.','d474.','d473.','d472.','d471.','d47s.','d47q.','d47p.','d47o.','d47n.','d47m.','d47l.','d47k.','d47j.','d47i.','d47h.','d47g.','d47f.','d47e.','d47d.','d47c.','d47b.','d47a.','d47F.','d47E.','d47D.','d47C.','d479.','d478.','d477.','d476.','d46..','d46z.','d46y.','d46x.','d463.','d462.','d461.','d45..','d45z.','d451.','d44..','d44z.','d44y.','d44x.','d44w.','d444.','d443.','d442.','d441.','d4l..','d4lG.','d4lE.','d4lC.','d4l2.','d4l1.','d4lF.','d4lD.','d4lB.','d4lA.','d4l9.','d4l8.','d4l7.','d4l6.','d4l5.','d4l4.','d4l3.','d43..','d43z.','d43y.','d432.','d431.','d41..','d41o.','d41m.','d41l.','d41k.','d41j.','d41B.','d41A.','d415.','d414.','d413.','d412.','d411.','d41i.','d41h.','d41g.','d41f.','d41e.','d41d.','d41c.','d41b.','d41a.','d419.','d418.','d417.','d416.','d42..','d42z.','d422.','d421.','d4x..','d4x4.','d4x2.','d4x3.','d4x1.','d4v..','d4vz.','d4vy.','d4vx.','d4vw.','d4vv.','d4vu.','d4vt.','d4vs.','d4vr.','d4v9.','d4v8.','d4v7.','d4v6.','d4v5.','d4v4.','d4v3.','d4v2.','d4v1.','d4t..','d4tz.','d4ty.','d4tx.','d4t2.','d4t1.','d4t7.','d4t6.','d4t5.','d4t4.','d4t3.','d57..','d57z.','d57y.','d578.','d577.','d576.','d575.','d574.','d573.','d572.','d571.','d56..','d564.','d563.','d562.','d561.','d58..','d58z.','d58y.','d58x.','d583.','d582.','d581.','d55..','d554.','d553.','d552.','d551.','d54..','d546.','d545.','d544.','d543.','d542.','d541.','d53..','d532.','d531.','d52..','d52x.','d52w.','d52v.','d52u.','d52t.','d52s.','d52a.','d529.','d528.','d527.','d526.','d525.','d524.','d523.','d522.','d521.','d52C.','d52B.','d52A.','d51..','d51z.','d51y.','d51x.','d51w.','d51v.','d51u.','d51t.','d51s.','d519.','d51a.','d518.','d517.','d516.','d515.','d514.','d513.','d512.','d511.','d71..','d71z.','d71y.','d71w.','d71v.','d71u.','d71j.','d71i.','d71h.','d713.','d712.','d711.','d71g.','d71f.','d71e.','d71d.','d71c.','d71b.','d71a.','d719.','d718.','d717.','d716.','d715.','d714.','d7c..','d7cy.','d7c9.','d7c8.','d7c7.','d7c6.','d7c5.','d7c4.','d7c3.','d7c2.','d7c1.','dhi..','dhe..','dhez.','dhey.','dhex.','dhew.','dhev.','dheu.','dhet.','dhes.','dher.','dhed.','dhec.','dheb.','dhea.','dheB.','dheA.','dhe9.','dhe8.','dhe7.','dhe6.','dhe5.','dhe4.','dhe3.','dhe2.','dhe1.','dh2..','o58..','o58z.','o581.','o54..','o541.','o52..','o52z.','o52y.','o522.','o521.','da1..','da1z.','da1y.','da12.','da11.','d915.','d917.','d916.','d914.','d913.','d84..','d84z.','d841.','dj26.','dj24.','o42w.','ds1..','dhg2.')
	and EntryDate >= '2015-01-01'
	and EntryDate <= '2020-05-14'
	group by PatID, EntryDate
) sub 
group by EntryDate

PRINT 'Date,IncidenceOfAntipsychotics,PrevalenceOfAntipsychotics'
select [date], ISNULL(i.num, 0), ISNULL(p.num, 0) from #AllDates d 
	left outer join #Incidence i on i.FirstDiagnosis = d.date
	left outer join #Prevalence p on p.EntryDate = d.date
order by date;
